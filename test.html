<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>臭宝的问题</title>
    <script src="echarts.js"></script>
    <link href="https://github.com/necolas/normalize.css">
</head>
<body>
<div style="width:100%;height:600px;" id="main"></div>
</body>
</html>

<script>
    function getQueryVariable(variable)
    {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return pair[1];}
        }
        return(false);
    }

    var formData = JSON.parse(decodeURI(getQueryVariable('formData')));


    var chartDom = document.getElementById('main');
    var myChart = echarts.init(chartDom);
    var option;

    var updateFrequency = 100;
    var dimension = 0;


    var res0 = [];
    var res1 = [];
    var options1 = formData.options;
    var ccc = {

    };

    for(let i = 0;i < formData.count;i++)
    {
        var key = Math.floor(Math.random() * options1.length);
        var randomItem = options1[key];

        if (ccc[key] != undefined)
        {
            ccc[key]++;
        }else{
            ccc[key] = 1;
        }
        for(let k =0;k < options1.length;k++)
        {
            res1.push([ccc[k]?ccc[k]:0,options1[k],i+1]);
        }

    }

    var countryColors = {};
    function color16() {
        var r = Math.floor(Math.random() * 256);
        var g = Math.floor(Math.random() * 256);
        var b = Math.floor(Math.random() * 256);
        var color = '#' + r.toString(16) + g.toString(16) + b.toString(16);
        return color;
    }
    for(let k =0;k < options1.length;k++)
    {
        countryColors[options1[k]] = color16();
    }

    console.log(res1);




        var flags = res0;
        var data = res1;
        var years = [];
        for (var i = 0; i < data.length; ++i) {
            if (years.length === 0 || years[years.length - 1] !== data[i][2]) {
                years.push(data[i][2]);
            }
        }

        function getFlag(countryName) {
            if (!countryName) {
                return '';
            }
            return (flags.find(function (item) {
                return item.name === countryName;
            }) || {}).emoji;
        }
        var startIndex = 0;
        var startYear = years[startIndex];

        var option = {
            title: {
                text: formData.question,
                subtext: formData.count+"次随机",
                left: "center",
                textStyle: {
                    fontSize: 30
                },
                subtextStyle: {
                    fontSize: 30,
                    fontWeight : 'bold',
                }
            },
            legend: {
                data: options1
            },
            grid: {
                top: 100,
                bottom: 100,
                left: 100,
                right: 40
            },
            xAxis: {
                type : 'value',
                max: 'dataMax',
                label: {
                    formatter: function (n) {
                        return Math.round(n);
                    },
                },
                axisLabel : {
                    fontWeight: "bold",
                    fontSize : 30,
                },
                axisLine:{
                    lineStyle:{
                        width:5,//这里是为了突出显示加上的
                    },
                },
                minInterval: 1,
                splitLine : {
                    width : 30
                },
            },
            dataset: {
                source: data.slice(1).filter(function (d) {
                    return d[2] === startYear;
                })
            },
            yAxis: {
                type: 'category',
                inverse: true,
                max: 10,
                axisLine:{
                    lineStyle:{
                        width:5,//这里是为了突出显示加上的
                    },
                },
                splitLine : {
                    width : 30
                },
                axisLabel: {
                    show: true,
                    textStyle: {
                        fontSize: 30,
                        fontWeight : 'bold',
                    },
                    formatter: function (value) {
                        return value;
                    },
                    rich: {
                        flag: {
                            fontSize: 30,
                            padding: 5,
                            fontWeight : 'bold',
                        }
                    },
                },
                minInterval: 1,
                animationDuration: 300,
                animationDurationUpdate: 300,


            },
            series: [{
                realtimeSort: true,
                seriesLayoutBy: 'column',
                type: 'bar',
                itemStyle: {
                    color: function (param) {
                        return countryColors[param.value[1]] || '#5470c6';
                    }
                },
                encode: {
                    x: dimension,
                    y: 3
                },
                label: {
                    show: true,
                    precision: 1,
                    position: 'right',
                    valueAnimation: true,
                    fontFamily: 'monospace',
                    fontSize : 30,
                    fontWeight : 'bold',
                    formatter : function (params) {
                        return parseInt(params.value[0]);
                    },
                },

            }],
            // Disable init animation.
            animationDuration: 0,
            animationDurationUpdate: updateFrequency,
            animationEasing: 'linear',
            animationEasingUpdate: 'linear',
            graphic: {
                elements: [{
                    type: 'text',
                    right: 160,
                    bottom: 60,
                    style: {
                        text: startYear,
                        font: 'bolder 80px monospace',
                        fill: 'rgba(100, 100, 100, 0.25)'
                    },
                    z: 100
                }]
            }
        };

        // console.log(option);
        myChart.setOption(option);

        for (var i = startIndex; i < years.length - 1; ++i) {
            (function (i) {
                setTimeout(function () {
                    updateYear(years[i + 1]);
                }, (i - startIndex) * updateFrequency);
            })(i);
        }

        function updateYear(year) {
            var source = data.slice(1).filter(function (d) {
                return d[2] === year;
            });

            option.series[0].data = source;
            option.graphic.elements[0].style.text = year;
            myChart.setOption(option);
        }


    option && myChart.setOption(option);

</script>